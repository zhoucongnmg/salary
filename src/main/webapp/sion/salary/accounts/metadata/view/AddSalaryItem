{
    "type": "Ext.window.Window",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "AddSalaryItem",
        "height": 480,
        "title": "新增方案项目",
        "width": 860
    },
    "name": "MyWindow",
    "designerId": "cd582d38-5ec4-4c34-a475-316acb53c35f",
    "cn": [
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "type"
                ],
                "fn": "getSalaryItem",
                "implHandler": [
                    "var me = this,",
                    "    grid = me.down('gridpanel'),",
                    "    store = grid.getStore(),",
                    "    accountItem = me._accountItem,",
                    "    system = false;",
                    "",
                    "if(type === 'System'){",
                    "    system = true;",
                    "}",
                    "store.clearFilter(true);",
                    "Ext.apply(store.proxy.extraParams, {",
                    "    system : system,",
                    "    type : type",
                    "});",
                    "store.load({",
                    "    scope: this,",
                    "    callback: function(records, operation, success) {",
                    "        if(accountItem !== null){",
                    "            var record = store.find('id', accountItem.get('salaryItemId'));",
                    "            grid.getSelectionModel().select(record);",
                    "        }",
                    "    }",
                    "});"
                ]
            },
            "name": "getSalaryItem",
            "designerId": "5f4966fd-056a-481a-b140-f89952ea6d6a"
        },
        {
            "type": "basiceventbinding",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "onWindowAfterRender",
                "implHandler": [
                    "var me = this,",
                    "    namespace = me.getNamespace(),",
                    "    form = me.down('form'),",
                    "    record = me._accountItem,",
                    "    store = Ext.getStore('AccountItem'),",
                    "    panel = me.down('#formulaPanel');",
                    "",
                    "if(record !== null && record.get('type') == 'Calculate' && record.get('formulaId') !== ''){",
                    "    Ext.Ajax.request({",
                    "        url: 'salary/formula/read',",
                    "        method: 'get',",
                    "        async: false,    //不使用异步",
                    "        params: {",
                    "            id: record.get('formulaId')",
                    "        },",
                    "        success: function(response, opts){",
                    "            var data = Ext.JSON.decode(response.responseText);",
                    "            record.set('formula', data);",
                    "        },",
                    "        failure: function(response, opts) {",
                    "            Ext.Msg.alert('提示信息','数据请求错误，请稍候重新尝试获取数据……');",
                    "        }",
                    "    });",
                    "}",
                    "var app = Ext.ClassManager.get('sion.salary.formula' + \".$application\").create();",
                    "var Api = app.getController('Api');",
                    "Api.initFormula({",
                    "    _formulaId : 'AddSalaryItem',//窗口的ItemId",
                    "    _container :  panel,//需要将公式编辑器面板显示到哪一个Container中",
                    "    _data : store.data.items,//计算项store(Model必须包含id,text等field)",
                    "    _command : record !== null && record.get('formula') !== null ? record.get('formula').formula : ''",
                    "});",
                    "me._formulaApi = Api;",
                    "if(record === null){",
                    "    record = Ext.create(namespace + '.model.AccountItem', {",
                    "        id : Ext.data.IdGenerator.get('uuid').generate()",
                    "    });",
                    "}else{",
                    "//     me.down('#type').setValue(record.get('type'));",
                    "    me.getSalaryItem(record.get('type'));",
                    "}",
                    "form.loadRecord(record);"
                ],
                "name": "afterrender",
                "scope": "me"
            },
            "name": "onWindowAfterRender",
            "designerId": "357383a3-fd31-429c-a930-178a9fb7174e"
        },
        {
            "type": "Ext.toolbar.Toolbar",
            "reference": {
                "name": "dockedItems",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "dock": "top"
            },
            "name": "MyToolbar6",
            "designerId": "b0cae79c-9103-4a64-a827-7d77dcc32d6a",
            "cn": [
                {
                    "type": "Ext.button.Button",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "iconCls": "s_icon_table_save",
                        "layout|flex": null,
                        "text": "确定",
                        "width": 70
                    },
                    "name": "MyButton7",
                    "designerId": "0443f03a-0e9c-4f45-9e68-29c401d38a1c",
                    "cn": [
                        {
                            "type": "basiceventbinding",
                            "reference": {
                                "name": "listeners",
                                "type": "array"
                            },
                            "codeClass": null,
                            "userConfig": {
                                "fn": "onButtonClick",
                                "implHandler": [
                                    "var me = this,",
                                    "    accountItem = me._accountItem,",
                                    "    grid = me.down('gridpanel'),",
                                    "    account = me._account,",
                                    "    form = me.down('form'),",
                                    "    record = form.getRecord(),",
                                    "    store = Ext.getStore('AccountItem'),",
                                    "    formulaItemStore = Ext.getStore('FormulaItem'),",
                                    "    select = grid.getSelectionModel().getSelection(),",
                                    "    formulaApi = me._formulaApi,",
                                    "    formulaItems = new Array();",
                                    "",
                                    "if(select.length < 1){",
                                    "    Ext.Msg.alert('提示', '请选择结果项');",
                                    "    return false;",
                                    "}",
                                    "var recordIndex = store.find('salaryItemId', select[0].data.id);",
                                    "if(accountItem === null){",
                                    "    if(recordIndex > -1){",
                                    "        Ext.Msg.alert('提示', '该项目已经存在，不能重复录入');",
                                    "        return false;",
                                    "    }",
                                    "}else{",
                                    "    if(recordIndex > -1 && recordIndex !== store.indexOf(record)){",
                                    "        Ext.Msg.alert('提示', '该项目已经存在，不能重复录入');",
                                    "        return false;",
                                    "    }",
                                    "}",
                                    "form.updateRecord(record);",
                                    "if(record.get('type') == 'System'){",
                                    "    record.set('value', '');",
                                    "}",
                                    "if(record.get('type') == 'Calculate'){",
                                    "    var formulaDatas = formulaApi.getFormula();",
                                    "    if(!formulaDatas){",
                                    "        Ext.Msg.alert('', '公式未完成，不能保存');",
                                    "        return false;",
                                    "    }",
                                    "    var formulaData = formulaDatas[formulaDatas.length - 1];",
                                    "    var va = formulaApi.validateFormula(formulaData);",
                                    "    var formulaFields = formulaApi.getFields(formulaData);",
                                    "    Ext.Array.each(formulaFields, function(formulaField){",
                                    "        var item = store.findRecord('id', formulaField.fieldId);",
                                    "        var formulaItem = {",
                                    "            value : '',",
                                    "            fieldId : item.data.salaryItemId,",
                                    "            text : formulaField.text,",
                                    "            type : 'Calculate'",
                                    "        };",
                                    "        formulaItems.push(formulaItem);",
                                    "    });",
                                    "    var formulaResult = {",
                                    "        value : '',",
                                    "        fieldId : select[0].data.id,",
                                    "        text : select[0].data.name,",
                                    "        type : 'Result'",
                                    "    };",
                                    "    formulaItems.push(formulaResult);",
                                    "    var formula = {",
                                    "        items : formulaItems,",
                                    "        resultFieldId : select[0].data.id,",
                                    "        formula : formulaData",
                                    "    };",
                                    "    record.set('formula', formula);",
                                    "    record.set('value', formulaData);",
                                    "}else{",
                                    "    record.set('formula', null);",
                                    "    record.set('formulaId', '');",
                                    "}",
                                    "record.set('salaryItemId', select[0].data.id);",
                                    "record.set('name', select[0].data.name);",
                                    "record.set('fieldName', select[0].data.field);",
                                    "if(accountItem === null){",
                                    "    store.add(record);",
                                    "}",
                                    "me.close();"
                                ],
                                "name": "click",
                                "scope": "me"
                            },
                            "name": "onButtonClick",
                            "designerId": "97a17018-c9a6-4e1e-861c-2340918063e7"
                        }
                    ]
                }
            ]
        },
        {
            "type": "Ext.form.Panel",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "bodyPadding": 10,
                "container|align": "stretch",
                "header": false,
                "layout": "hbox",
                "title": null,
                "width": "100%"
            },
            "name": "MyForm4",
            "designerId": "ae052a01-35f1-4b8a-8450-aab179435331",
            "cn": [
                {
                    "type": "Ext.form.FieldSet",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "height": 381,
                        "title": "项目",
                        "width": 300
                    },
                    "name": "MyFieldSet1",
                    "designerId": "9787f9e9-0ae6-44b9-b852-82cab4f1dae5",
                    "cn": [
                        {
                            "type": "Ext.form.field.Checkbox",
                            "reference": {
                                "name": "items",
                                "type": "array"
                            },
                            "codeClass": null,
                            "userConfig": {
                                "boxLabel": "在薪资报表中显示",
                                "fieldLabel": null,
                                "hideEmptyLabel": false,
                                "layout|anchor": "100%",
                                "name": "show"
                            },
                            "name": "MyCheckbox2",
                            "designerId": "fc142102-069d-461e-b34f-c066c988f4cf"
                        },
                        {
                            "type": "Ext.form.field.ComboBox",
                            "reference": {
                                "name": "items",
                                "type": "array"
                            },
                            "codeClass": null,
                            "userConfig": {
                                "displayField": "name",
                                "fieldLabel": "类型",
                                "itemId": "type",
                                "layout|anchor": "100%",
                                "name": "type",
                                "store": "AccountItemType",
                                "valueField": "id"
                            },
                            "name": "MyComboBox2",
                            "designerId": "598a0e7e-ad90-4f71-8804-a96f7e773386",
                            "cn": [
                                {
                                    "type": "basiceventbinding",
                                    "reference": {
                                        "name": "listeners",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "fn": "onTypeChange",
                                        "implHandler": [
                                            "var me = this,",
                                            "    store = Ext.getStore('SalaryItem'),",
                                            "    window = field.up(\"window\");",
                                            "",
                                            "if('Calculate' == newValue){",
                                            "    me.down('#formulaPanel').show();",
                                            "    me.down('#inputPanel').hide();",
                                            "    me.getSalaryItem(newValue);",
                                            "}else if('Input' == newValue){",
                                            "    me.down('#formulaPanel').hide();",
                                            "    me.down('#inputPanel').show();",
                                            "    me.getSalaryItem(newValue);",
                                            "}else if('System' == newValue){",
                                            "    me.down('#formulaPanel').hide();",
                                            "    me.down('#inputPanel').hide();",
                                            "    me.getSalaryItem(newValue);",
                                            "}else{",
                                            "    store.removeAll();",
                                            "}"
                                        ],
                                        "name": "change",
                                        "scope": "me"
                                    },
                                    "name": "onTypeChange",
                                    "designerId": "ec92136f-39fe-4c45-ade5-404fb491045c"
                                }
                            ]
                        },
                        {
                            "type": "Ext.grid.Panel",
                            "reference": {
                                "name": "items",
                                "type": "array"
                            },
                            "codeClass": null,
                            "userConfig": {
                                "header": false,
                                "store": "SalaryItem",
                                "title": null
                            },
                            "name": "MyGridPanel3",
                            "designerId": "d625067c-d2a5-45fa-b69f-c138fd3cf894",
                            "cn": [
                                {
                                    "type": "Ext.grid.column.Column",
                                    "reference": {
                                        "name": "columns",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "dataIndex": "name",
                                        "text": "请选择结果项",
                                        "width": "100%"
                                    },
                                    "name": "MyColumn2",
                                    "designerId": "e6cbc653-1b82-4b9c-aaf0-f8ca6182e949"
                                },
                                {
                                    "type": "Ext.grid.View",
                                    "reference": {
                                        "name": "viewConfig",
                                        "type": "object"
                                    },
                                    "codeClass": null,
                                    "name": "MyGridView4",
                                    "designerId": "f034aa33-7ec4-4393-9128-e8e52b90a224"
                                }
                            ]
                        }
                    ]
                },
                {
                    "type": "Ext.form.FieldSet",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "hidden": true,
                        "itemId": "inputPanel",
                        "layout|flex": 1,
                        "layout|margins": "0 10 0 20",
                        "style": [
                            "padding-top:10px;"
                        ],
                        "title": null,
                        "width": 100
                    },
                    "name": "MyFieldSet2",
                    "designerId": "87ea8b74-5f90-41fe-9b94-c61bcb48f086",
                    "cn": [
                        {
                            "type": "Ext.form.field.TextArea",
                            "reference": {
                                "name": "items",
                                "type": "array"
                            },
                            "codeClass": null,
                            "userConfig": {
                                "fieldLabel": "值",
                                "labelWidth": 20,
                                "layout|anchor": "100%",
                                "name": "value",
                                "rows": 20
                            },
                            "name": "MyTextArea",
                            "designerId": "c7ce64d6-10ae-40bb-b237-48c41541c8cb"
                        }
                    ]
                },
                {
                    "type": "Ext.form.FieldSet",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "hidden": true,
                        "itemId": "formulaPanel",
                        "layout": "fit",
                        "layout|flex": 1,
                        "layout|margins": "0 10 0 20",
                        "title": "公式",
                        "width": 100
                    },
                    "name": "MyFieldSet4",
                    "designerId": "8878fd4c-3d8f-4686-86a0-101fd6893362"
                }
            ]
        }
    ]
}