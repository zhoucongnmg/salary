/*
 * File: app/controller/Api.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('sion.salary.formula.controller.Api', {
    extend: 'Ext.app.Controller',

    getTerminalCtrl: function() {
        return this.getController('Terminal');
    },

    getFormula: function() {
        var me = this,
            config = me._config,
            formulaId = config._formulaId,
            ctrl = me.getTerminalCtrl(),
            term = ctrl.getTerm(formulaId),
            command = ctrl.getCommand(formulaId);


        return term._history.push(command);
    },

    validateFormula: function(formula) {
        var me = this,
            config = me._config,
            formulaId = config._formulaId,
            ctrl = me.getTerminalCtrl(),
            validator = me.getValidatorCtrl();

        return validator.validate(formula,config._data);
    },

    getFields: function(formula) {
        var me = this,
            config = me._config,
            data = config._data,
            json = [];

        Ext.Array.each(data,function(record,index) {
            var text = record.get('name');
            if (formula.indexOf('[' + text + ']')>-1){
                json.push({
                    fieldId : record.get('id'),
                    text : text
                });
            }

        });
        return json;
    },

    initFormula: function(config) {
        /**
        config : {
            _formulaId : //窗口的ItemId
            _container :  //需要将公式编辑器面板显示到哪一个Container中
            _data : //计算项store(Model必须包含id,text等field),
            _command: //已存在的公式用于回显
        }
                     **/
        Ext.util.CSS.swapStyleSheet('formula-base','sion/salary/formula/resources/formula.css');
        Ext.util.CSS.swapStyleSheet('formula-terminal','sion/salary/formula/jqueryTerminal/terminal.css');
        Ext.util.CSS.swapStyleSheet('formula-terminal-base','sion/salary/formula/jqueryTerminal/style.css');


        var me = this,
            container = config._container,
            ns = me.getNamespace(),
            main,win;

        me._config = config;
        if (container) {
            main = Ext.create(ns + '.view.Main',{
                _data : config._data,
                _formulaId : config._formulaId,
                _command : config._command
            });
            container.add(main);
        }else {
            win = Ext.create(ns + '.view.FormulaWin',{
                _data : config._data,
                _formulaId : config._formulaId,
                _command : config._command
            });
            win.show();
        }

    }

});
