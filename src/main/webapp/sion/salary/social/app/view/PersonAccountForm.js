/*
 * File: app/view/PersonAccountForm.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('sion.salary.social.view.PersonAccountForm', {
    extend: 'Ext.window.Window',

    requires: [
        'Ext.toolbar.Toolbar',
        'Ext.tab.Panel',
        'Ext.form.Panel',
        'Ext.tab.Tab',
        'Ext.toolbar.Spacer',
        'Ext.form.field.ComboBox',
        'Ext.grid.Panel',
        'Ext.grid.column.Column',
        'Ext.grid.View',
        'Ext.form.field.Date',
        'Ext.form.field.Checkbox'
    ],

    height: 766,
    width: 861,
    layout: 'column',
    bodyPadding: 10,

    initComponent: function() {
        var me = this;

        Ext.applyIf(me, {
            dockedItems: [
                {
                    xtype: 'toolbar',
                    dock: 'top',
                    items: [
                        {
                            xtype: 'button',
                            iconCls: 's_icon_page_add',
                            text: '保存信息',
                            listeners: {
                                click: {
                                    fn: me.onSaveClick,
                                    scope: me
                                }
                            }
                        }
                    ]
                }
            ],
            items: [
                {
                    xtype: 'tabpanel',
                    columnWidth: 1,
                    activeTab: 0,
                    items: [
                        {
                            xtype: 'form',
                            itemId: 'salaryForm',
                            layout: 'column',
                            bodyPadding: 10,
                            title: '基本信息',
                            items: [
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    itemId: 'personCode',
                                    fieldLabel: '员工编号',
                                    labelWidth: 80,
                                    name: 'personCode'
                                },
                                {
                                    xtype: 'button',
                                    text: '搜',
                                    listeners: {
                                        click: {
                                            fn: me.onSearchClick,
                                            scope: me
                                        }
                                    }
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    itemId: 'name',
                                    fieldLabel: '姓名',
                                    labelWidth: 80,
                                    name: 'name'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1.1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    itemId: 'dept',
                                    fieldLabel: '部门',
                                    labelWidth: 80,
                                    name: 'dept'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    itemId: 'duty',
                                    fieldLabel: '职务',
                                    labelWidth: 80,
                                    name: 'duty'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1.1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    itemId: 'idCard',
                                    fieldLabel: '身份证号',
                                    labelWidth: 80,
                                    name: 'idCard'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1.1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    fieldLabel: '工资卡号',
                                    labelWidth: 80,
                                    name: 'bankAccount'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    fieldLabel: '银行',
                                    labelWidth: 80,
                                    name: 'bank'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1.1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    fieldLabel: '开户网点',
                                    labelWidth: 80,
                                    name: 'bankOfDeposit'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'combobox',
                                    columnWidth: 0.45,
                                    fieldLabel: '薪资方案',
                                    labelWidth: 80,
                                    name: 'accountId',
                                    store: 'SalaryAccount'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1.1,
                                    height: 20
                                },
                                {
                                    xtype: 'combobox',
                                    columnWidth: 0.45,
                                    itemId: 'level',
                                    fieldLabel: '薪资层次',
                                    labelWidth: 80,
                                    name: 'level',
                                    displayField: 'name',
                                    store: 'LevelStore',
                                    valueField: 'id'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'combobox',
                                    columnWidth: 0.45,
                                    fieldLabel: '薪资级别',
                                    labelWidth: 80,
                                    name: 'rank'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 1,
                                    margin: '10 0 0 0',
                                    fieldLabel: '备注',
                                    labelWidth: 80,
                                    name: 'note'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20,
                                    width: 100
                                },
                                {
                                    xtype: 'gridpanel',
                                    columnWidth: 1,
                                    itemId: 'SalaryItemGrid',
                                    header: false,
                                    title: 'My Grid Panel',
                                    columns: [
                                        {
                                            xtype: 'gridcolumn',
                                            width: '40%',
                                            dataIndex: 'string',
                                            text: '工资项目'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            width: '58%',
                                            text: '值'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                }
                            ]
                        },
                        {
                            xtype: 'form',
                            itemId: 'socialForm',
                            layout: 'column',
                            bodyPadding: 10,
                            title: '社保信息',
                            items: [
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    fieldLabel: '社保号',
                                    labelWidth: 80,
                                    name: 'insuredNo'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'datefield',
                                    columnWidth: 0.45,
                                    fieldLabel: '参保日期',
                                    labelWidth: 80,
                                    name: 'insuredDate',
                                    editable: false,
                                    format: 'Y-m-d'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.45,
                                    fieldLabel: '工作地',
                                    labelWidth: 80,
                                    name: 'workplace'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'combobox',
                                    columnWidth: 0.45,
                                    fieldLabel: '参保状态',
                                    labelWidth: 80,
                                    name: 'status',
                                    editable: false,
                                    store: [
                                        [
                                            'In',
                                            '在保'
                                        ],
                                        [
                                            'Out',
                                            '退保'
                                        ]
                                    ]
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                },
                                {
                                    xtype: 'datefield',
                                    columnWidth: 0.45,
                                    fieldLabel: '退保日期',
                                    labelWidth: 80,
                                    name: 'outDate',
                                    editable: false,
                                    format: 'Y-m-d'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'combobox',
                                    columnWidth: 0.45,
                                    itemId: 'socialAccount',
                                    fieldLabel: '社保方案',
                                    labelWidth: 80,
                                    name: 'accountId',
                                    displayField: 'name',
                                    store: 'SocialAccount',
                                    valueField: 'id'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                },
                                {
                                    xtype: 'gridpanel',
                                    columnWidth: 1,
                                    header: false,
                                    title: 'My Tab',
                                    columns: [
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '项目名称',
                                            flex: 1
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '基数',
                                            flex: 0.6
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '单位购买类型',
                                            flex: 1.25
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '单位购买百分比',
                                            flex: 1.7
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '单位购买金额',
                                            flex: 1.25
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '个人购买类型',
                                            flex: 1.25
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '个人购买百分比',
                                            flex: 1.7
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'string',
                                            text: '个人购买金额',
                                            flex: 1.25
                                        }
                                    ]
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                },
                                {
                                    xtype: 'checkboxfield',
                                    columnWidth: 0.15,
                                    fieldLabel: '社保代付地',
                                    labelWidth: 80
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.295,
                                    padding: '0 0 0 10',
                                    name: 'socialWorkplace'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 0.1,
                                    height: 20
                                },
                                {
                                    xtype: 'checkboxfield',
                                    columnWidth: 0.15,
                                    fieldLabel: '公积金代付地',
                                    labelWidth: 90
                                },
                                {
                                    xtype: 'textfield',
                                    columnWidth: 0.295,
                                    padding: '0 0 0 10',
                                    name: 'accumulationFundsWorkplace'
                                },
                                {
                                    xtype: 'tbspacer',
                                    columnWidth: 1,
                                    height: 20
                                }
                            ]
                        }
                    ]
                }
            ],
            listeners: {
                afterrender: {
                    fn: me.onWindowAfterRender,
                    scope: me
                }
            }
        });

        me.callParent(arguments);
    },

    onSaveClick: function(button, e, eOpts) {
        var me =this,
            namespace=me.getNamespace(),
            salaryForm=me.down('#salaryForm'),
            socialForm=me.down('#socialForm'),
            accountItems=[],
            insuredPerson,
            model;

        if(me._record){
            model=Ext.create(namespace+".model.PersonAccount",salaryForm.getValues());
            model.set('id',me._record.data.id);
        }
        else{
            model=Ext.create(namespace+".model.PersonAccount",salaryForm.getValues());
        }

        model.set("accountItems",accountItems);
        insuredPerson=Ext.create(namespace+".model.InsuredPerson",socialForm.getValues());
        model.set('insuredPerson',insuredPerson.data);
        button.disabled=true;
        Ext.Ajax.request({
            url: 'salary/person/create',
            method:'POST',
            jsonData: model.data,
            success:function(response){
                var res=Ext.JSON.decode(response.responseText);
                Ext.Msg.alert("提示",res.message);
                if(res.success==false)
                {
                    return;
                }
                if(me._grid){
                    me._grid.getStore().reload();
                }
                button.disabled=false;
                me.close();
            },
            failure:function(form,action){
                Ext.Msg.alert("提示","保存信息失败!");
                button.disabled=false;
            }
        });
    },

    onSearchClick: function(button, e, eOpts) {
        var personSelection =Ext.create("Sion.Hr.Base.view.PersonSelection",
                                        {_scope:this,_callback:this.selectedCallback});
        personSelection.show();
    },

    onWindowAfterRender: function(component, eOpts) {
        var me=this,
            salaryForm=me.down('#salaryForm'),
            socialForm=me.down('#socialForm');

        if(me._record){
            salaryForm.getForm().setValues(me._record.data);
            socialForm.getForm().setValues(me._record.data.insuredPerson);
        }

        //load combobox
        var level=me.down('#level'),
            socialAccount=me.down('#socialAccount');

        level.getStore().load();
        socialAccount.getStore().load();
    },

    selectedCallback: function(person, scope) {
        var me=scope,
            salaryForm=me.down('#salaryForm'),
            socialForm=me.down('#socialForm');

        salaryForm.down('#personCode').setValue(person.data.serialNum);
        salaryForm.down('#name').setValue(person.data.name);
        salaryForm.down('#dept').setValue(person.data.deptName);
        salaryForm.down('#duty').setValue(person.data.position);
        salaryForm.down('#idCard').setValue(person.data.idCard);

    }

});